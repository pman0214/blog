<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Debian jessieにRedmineをインストールする - pLog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://pman0214.github.io/blog/redmine-install.html">

        <meta name="author" content="pman0214" />
        <meta name="keywords" content="redmine,debian,backlogs" />
        <meta name="description" content="Debian jessieのnginx上にRedmine+Backlogsを導入する手順について説明する。" />

        <meta property="og:site_name" content="pLog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Debian jessieにRedmineをインストールする"/>
        <meta property="og:url" content="http://pman0214.github.io/blog/redmine-install.html"/>
        <meta property="og:description" content="Debian jessieのnginx上にRedmine+Backlogsを導入する手順について説明する。"/>
        <meta property="article:published_time" content="2015-05-16" />
            <meta property="article:section" content="技術" />
            <meta property="article:tag" content="redmine" />
            <meta property="article:tag" content="debian" />
            <meta property="article:tag" content="backlogs" />
            <meta property="article:author" content="pman0214" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://pman0214.github.io/blog/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://pman0214.github.io/blog/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://pman0214.github.io/blog/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://pman0214.github.io/blog/theme/css/style.css" type="text/css"/>

        <link href="http://pman0214.github.io/blog/feeds/atom.xml" type="application/atom+xml" rel="alternate"
              title="pLog ATOM Feed"/>

        <link href="http://pman0214.github.io/blog/feeds/rss.xml" type="application/rss+xml" rel="alternate"
              title="pLog RSS Feed"/>



</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://pman0214.github.io/blog/" class="navbar-brand">
pLog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="http://pman0214.github.io/blog/category/ji-shu.html">技術</a>
                        </li>
                        <li >
                            <a href="http://pman0214.github.io/blog/category/ozhi-rase.html">お知らせ</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://pman0214.github.io/blog/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://pman0214.github.io/blog/redmine-install.html"
                       rel="bookmark"
                       title="Permalink to Debian jessieにRedmineをインストールする">
                        Debian jessieにRedmineをインストールする
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-05-16T15:00:00+09:00"> 土 16 5月 2015</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="http://pman0214.github.io/blog/tag/redmine.html">redmine</a>
        /
	<a href="http://pman0214.github.io/blog/tag/debian.html">debian</a>
        /
	<a href="http://pman0214.github.io/blog/tag/backlogs.html">backlogs</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h1>環境</h1>
<ul>
<li>debian jessie 8.0<ul>
<li>debianマシンはすでに用意してあるものとする。</li>
</ul>
</li>
<li>redmine 2.6.5</li>
<li>backlogs 1.0.6</li>
</ul>
<h1>手順</h1>
<h2>redmine本体</h2>
<p>必要なツール類をインストールする。MySQLを使うことが多いのだが、個人的な好みによりPostgreSQLを使用することにする。</p>
<div class="highlight"><pre><span class="c">% sudo apt-get install postgresql ruby ruby-dev ruby-pg libpq-dev \</span>
  <span class="n">make</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span> <span class="n">gcc</span> <span class="o">\</span>
  <span class="n">imagemagick</span> <span class="n">libmagickwand</span><span class="o">-</span><span class="n">dev</span> <span class="n">git</span><span class="o">-</span><span class="n">core</span> <span class="n">subversion</span>
</pre></div>


<p>PostgreSQLに接続してユーザやDBの作成を行う。<code>password</code>の部分はもちろん変更すべし。パスワードに記号が入っているとredmineで接続できない場合があるので、英数に限定する方がいいかも。</p>
<div class="highlight"><pre><span class="c">% sudo -u postgres psql</span>
<span class="n">postgres</span># <span class="n">CREATE</span> <span class="n">ROLE</span> <span class="n">redmine</span> <span class="n">LOGIN</span> <span class="n">ENCRYPTED</span> <span class="n">PASSWORD</span> <span class="s">&#39;password&#39;</span> <span class="n">NOINHERIT</span> <span class="n">VALID</span> <span class="n">UNTIL</span> <span class="s">&#39;infinity&#39;</span><span class="p">;</span>
<span class="n">postgres</span># <span class="n">CREATE</span> <span class="n">DATABASE</span> <span class="n">redmine</span> <span class="n">WITH</span> <span class="n">ENCODING</span><span class="p">=</span><span class="s">&#39;UTF8&#39;</span> <span class="n">OWNER</span><span class="p">=</span><span class="n">redmine</span><span class="p">;</span>
<span class="n">postgres</span># <span class="o">\</span><span class="n">q</span>
</pre></div>


<p>Linuxにユーザ<code>redmine</code>を追加する。</p>
<div class="highlight"><pre><span class="c">% sudo adduser --disabled-login --gecos &#39;Redmine&#39; redmine</span>
</pre></div>


<p>パスワードを設定しておく。</p>
<div class="highlight"><pre><span class="c">% sudo passwd redmine</span>
</pre></div>


<p>sudoグループにユーザ<code>redmine</code>を加えておく。Debianでは<code>visudo</code>でユーザを追加せず、このグループにユーザを追加するだけでsudoできるように設定されている。</p>
<div class="highlight"><pre><span class="c">% sudo vi /etc/group</span>
<span class="c">...</span>
<span class="n">sudo</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="n">redmine</span> ← ★<span class="n">redmine</span>を追加する
<span class="c">...</span>
</pre></div>


<p><a href="http://www.redmine.org/">Redmineの公式web</a>からソースをゲットする。Backlogsは2.2.4と2.3.2に対応と書かれているが、今回は執筆時点での最新版2.6.5にBacklogsを導入するという暴挙に出る。</p>
<p><code>sudo -u redmine</code>を多用するのでaliasしておく。</p>
<div class="highlight"><pre><span class="c">% alias sr=&#39;sudo -u redmine&#39;</span>
<span class="c">% cd /home/redmine</span>
<span class="c">% sr wget http://www.redmine.org/releases/redmine-2.6.5.tar.gz</span>
<span class="c">% sr tar zxvf redmine-2.6.5.tar.gz</span>
<span class="c">% sr ln -s redmine-2.6.5 redmine</span>
<span class="c">% cd redmine</span>
</pre></div>


<p>database.ymlのテンプレートをコピーし、設定を施す。</p>
<p>MySQLの設定をコメントアウトしてPostgreSQLの設定を有効化し、設定を変更する。
testもコメントアウトしてしまってOK。</p>
<div class="highlight"><pre><span class="c">% sr cp config/database.yml.example config/database.yml</span>
<span class="c">% sr vi config/database.yml</span>
<span class="c">...</span>
<span class="n">production</span><span class="p">:</span>
  <span class="n">adapter</span><span class="p">:</span> <span class="n">postgresql</span>
  <span class="n">database</span><span class="p">:</span> <span class="n">redmine</span>
  <span class="n">host</span><span class="p">:</span> <span class="n">localhost</span>
  <span class="n">username</span><span class="p">:</span> <span class="n">redmine</span> ← ★<span class="n">postgres</span>になっているので変更する
  <span class="n">password</span><span class="p">:</span> &quot;<span class="n">password</span>&quot; ← ★パスワードは最初に<span class="n">PostgreSQL</span>に設定したもの。
<span class="c">...</span>
</pre></div>


<p>bundlerを導入してbundleする。システムのrubyを使っているのでbundlerはsudoで入れてしまう。</p>
<div class="highlight"><pre><span class="c">% sudo gem install bundler</span>
<span class="c">% sr bundle install --without development test</span>
</pre></div>


<p>つづいてrake。</p>
<div class="highlight"><pre><span class="c">% sr rake generate_secret_token</span>
<span class="c">% sr RAILS_ENV=production rake db:migrate</span>
<span class="c">% sr RAILS_ENV=production rake redmine:load_default_data</span>
<span class="n">Select</span> <span class="n">Language</span><span class="p">:</span> <span class="n">ja</span> ← ★日本語を指定
</pre></div>


<p>試しにサーバを動かしてみる。</p>
<div class="highlight"><pre><span class="c">% sr ruby script/rails server webrick -e production</span>
</pre></div>


<p>この状態で<code>http://debianサーバ:3000/</code>に接続して、redmineが見られればOK。
Ctrl-Cでサーバを停止できる。</p>
<h2>ログ消去</h2>
<p>ログが永遠に作成されたら嫌なので、logrotateを使って自動的に消去する。</p>
<div class="highlight"><pre><span class="c">% sudo vi /etc/logrotate.d/redmine</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">redmine</span><span class="o">/</span><span class="n">redmine</span><span class="o">/</span><span class="nb">log</span><span class="o">/*</span><span class="p">.</span><span class="nb">log</span> <span class="p">{</span>
    <span class="n">rotate</span> <span class="mi">3</span>
    <span class="nb">size</span> <span class="mi">1</span><span class="n">M</span>
    <span class="n">compress</span>
    <span class="n">missingok</span>
    <span class="n">notifempty</span>
    <span class="n">copytruncate</span>
<span class="p">}</span>
</pre></div>


<p>テストしてみる。</p>
<div class="highlight"><pre><span class="c">% sudo logrotate -dv /etc/logrotate.conf</span>
</pre></div>


<h1>nginx + unicornにする</h1>
<p>WEBrickを使うのはアレなのでnginxに乗っける。</p>
<p>まずはunicornをbundleする。</p>
<div class="highlight"><pre><span class="c">% sr vi Gemfile.local</span>
<span class="n">gem</span> &quot;<span class="n">unicorn</span>&quot;
</pre></div>


<p>unicornの設定ファイルを作成する。</p>
<div class="highlight"><pre><span class="c">% sr vi config/unicorn.rb</span>
<span class="n">worker_processes</span> <span class="mi">2</span>
<span class="n">working_directory</span> &quot;<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">redmine</span><span class="o">/</span><span class="n">redmine</span>&quot;

<span class="n">listen</span> <span class="n">File</span><span class="p">.</span><span class="n">expand_path</span><span class="p">(</span>&quot;<span class="n">tmp</span><span class="o">/</span><span class="n">unicorn</span><span class="p">.</span><span class="n">sock</span>&quot;<span class="p">,</span> <span class="n">ENV</span><span class="p">[</span><span class="s">&#39;RAILS_ROOT&#39;</span><span class="p">])</span>
<span class="n">listen</span> &quot;<span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8079</span>&quot;<span class="p">,</span> <span class="p">:</span><span class="n">tcp_nopush</span> <span class="p">=</span><span class="o">&gt;</span> <span class="n">true</span>

<span class="n">pid</span> <span class="n">File</span><span class="p">.</span><span class="n">expand_path</span><span class="p">(</span>&quot;<span class="n">tmp</span><span class="o">/</span><span class="n">unicorn</span><span class="p">.</span><span class="n">pid</span>&quot;<span class="p">,</span> <span class="n">ENV</span><span class="p">[</span><span class="s">&#39;RAILS_ROOT&#39;</span><span class="p">])</span>

<span class="n">timeout</span> <span class="mi">60</span>

<span class="n">preload_app</span> <span class="n">true</span>

<span class="n">stdout_path</span> <span class="n">File</span><span class="p">.</span><span class="n">expand_path</span><span class="p">(</span>&quot;<span class="nb">log</span><span class="o">/</span><span class="n">unicorn</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nb">log</span>&quot;<span class="p">,</span> <span class="n">ENV</span><span class="p">[</span><span class="s">&#39;RAILS_ROOT&#39;</span><span class="p">])</span>
<span class="n">stderr_path</span> <span class="n">File</span><span class="p">.</span><span class="n">expand_path</span><span class="p">(</span>&quot;<span class="nb">log</span><span class="o">/</span><span class="n">unicorn</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nb">log</span>&quot;<span class="p">,</span> <span class="n">ENV</span><span class="p">[</span><span class="s">&#39;RAILS_ROOT&#39;</span><span class="p">])</span>

<span class="n">GC</span><span class="p">.</span><span class="n">respond_to</span>?<span class="p">(:</span><span class="n">copy_on_write_friendly</span><span class="p">=)</span> <span class="n">and</span> <span class="n">GC</span><span class="p">.</span><span class="n">copy_on_write_friendly</span> <span class="p">=</span> <span class="n">true</span>

<span class="n">before_fork</span> <span class="n">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
  <span class="n">defined</span>?<span class="p">(</span><span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Base</span><span class="p">)</span> <span class="n">and</span> <span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Base</span><span class="p">.</span><span class="n">connection</span><span class="p">.</span><span class="n">disconnect</span>!

  <span class="n">old_pid</span> <span class="p">=</span> &quot;#<span class="p">{</span><span class="n">server</span><span class="p">.</span><span class="n">config</span><span class="p">[:</span><span class="n">pid</span><span class="p">]}.</span><span class="n">oldbin</span>&quot;
    <span class="k">if</span> <span class="n">old_pid</span> !<span class="p">=</span> <span class="n">server</span><span class="p">.</span><span class="n">pid</span>
      <span class="n">begin</span>
        <span class="n">sig</span> <span class="p">=</span> <span class="p">(</span><span class="n">worker</span><span class="p">.</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span><span class="p">=</span> <span class="n">server</span><span class="p">.</span><span class="n">worker_processes</span> ? <span class="p">:</span><span class="n">QUIT</span> <span class="p">:</span> <span class="p">:</span><span class="n">TTOU</span>
        <span class="n">Process</span><span class="p">.</span><span class="n">kill</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">File</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">old_pid</span><span class="p">).</span><span class="n">to_i</span><span class="p">)</span>
      <span class="n">rescue</span> <span class="n">Errno</span><span class="p">::</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">Errno</span><span class="p">::</span><span class="n">ESRCH</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">sleep</span> <span class="mi">1</span>
  <span class="k">end</span>

<span class="n">after_fork</span> <span class="n">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
  <span class="n">defined</span>?<span class="p">(</span><span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Base</span><span class="p">)</span> <span class="n">and</span> <span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Base</span><span class="p">.</span><span class="n">establish_connection</span>
<span class="k">end</span>
</pre></div>


<p>initスクリプトを作成する。上の方の設定は自信無い。</p>
<div class="highlight"><pre><span class="c">% sudo vi /etc/init.d/redmine</span>
#!<span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>

### <span class="n">BEGIN</span> <span class="n">INIT</span> <span class="n">INFO</span>
# <span class="n">Provides</span><span class="p">:</span>          <span class="n">redmine</span>
# <span class="n">Required</span><span class="o">-</span><span class="n">Start</span><span class="p">:</span>    $<span class="n">local_fs</span> $<span class="n">remote_fs</span> $<span class="n">network</span> $<span class="n">syslog</span>
# <span class="n">Required</span><span class="o">-</span><span class="n">Stop</span><span class="p">:</span>     $<span class="n">local_fs</span> $<span class="n">remote_fs</span> $<span class="n">network</span> $<span class="n">syslog</span>
# <span class="n">Default</span><span class="o">-</span><span class="n">Start</span><span class="p">:</span>     <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span>
# <span class="n">Default</span><span class="o">-</span><span class="n">Stop</span><span class="p">:</span>      <span class="mi">0</span> <span class="mi">1</span> <span class="mi">6</span>
# <span class="n">Short</span><span class="o">-</span><span class="n">Description</span><span class="p">:</span> <span class="n">redmine</span> <span class="n">unicorn</span>
# <span class="n">Description</span><span class="p">:</span>       <span class="n">redmine</span> <span class="n">unicorn</span>
# <span class="n">chkconfig</span><span class="p">:</span> <span class="o">-</span> <span class="mi">75</span> <span class="mi">25</span>
### <span class="n">END</span> <span class="n">INIT</span> <span class="n">INFO</span>

<span class="n">export</span> <span class="n">PATH</span><span class="p">=</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span>

# <span class="n">move</span> <span class="n">to</span> <span class="n">project</span> <span class="n">root</span> <span class="n">directory</span>
<span class="n">NAME</span><span class="p">=</span><span class="n">redmine</span>
<span class="n">ENVIROMENT</span><span class="p">=</span><span class="n">production</span>
<span class="n">APP_USER</span><span class="p">=</span>&quot;<span class="n">redmine</span>&quot;

<span class="n">ROOT_DIR</span><span class="p">=</span>&quot;<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">redmine</span><span class="o">/</span><span class="n">redmine</span>&quot;

<span class="n">PID</span><span class="p">=</span>&quot;$<span class="p">{</span><span class="n">ROOT_DIR</span><span class="p">}</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">unicorn</span><span class="p">.</span><span class="n">pid</span>&quot;
<span class="n">CONF</span><span class="p">=</span>&quot;$<span class="p">{</span><span class="n">ROOT_DIR</span><span class="p">}</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">unicorn</span><span class="p">.</span><span class="n">rb</span>&quot;

<span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">[</span> <span class="o">-</span><span class="n">e</span> $<span class="n">PID</span> <span class="p">];</span> <span class="n">then</span>
    <span class="n">echo</span> &quot;$<span class="n">NAME</span> <span class="n">already</span> <span class="n">started</span>&quot;<span class="p">;</span>
    <span class="n">exit</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">fi</span>
  <span class="n">echo</span> &quot;<span class="n">start</span> $<span class="n">NAME</span>&quot;<span class="p">;</span>
  <span class="n">cd</span> $<span class="n">ROOT_DIR</span>
  <span class="n">sudo</span> <span class="o">-</span><span class="n">u</span> $<span class="p">{</span><span class="n">APP_USER</span><span class="p">}</span> <span class="o">-</span><span class="n">H</span> <span class="n">bundle</span> <span class="n">exec</span> <span class="n">unicorn_rails</span> <span class="o">-</span><span class="n">c</span> $<span class="p">{</span><span class="n">CONF</span><span class="p">}</span> <span class="o">-</span><span class="n">E</span> $<span class="p">{</span><span class="n">ENVIROMENT</span><span class="p">}</span> <span class="o">-</span><span class="n">D</span>
<span class="p">}</span>

<span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">[</span> ! <span class="o">-</span><span class="n">e</span> $<span class="n">PID</span> <span class="p">];</span> <span class="n">then</span>
    <span class="n">echo</span> &quot;$<span class="n">NAME</span> <span class="n">not</span> <span class="n">started</span>&quot;<span class="p">;</span>
    <span class="n">exit</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">fi</span>
  <span class="n">echo</span> &quot;<span class="n">stop</span> $<span class="n">NAME</span>&quot;<span class="p">;</span>
  <span class="n">kill</span> <span class="o">-</span><span class="n">QUIT</span> `<span class="nb">cat</span> $<span class="p">{</span><span class="n">PID</span><span class="p">}</span>`
  <span class="n">rm</span> <span class="o">-</span><span class="n">f</span> $<span class="n">PID</span>
<span class="p">}</span>

<span class="n">force_stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">[</span> ! <span class="o">-</span><span class="n">e</span> $<span class="n">PID</span> <span class="p">];</span> <span class="n">then</span>
    <span class="n">echo</span> &quot;$<span class="n">NAME</span> <span class="n">not</span> <span class="n">started</span>&quot;<span class="p">;</span>
    <span class="n">exit</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">fi</span>
  <span class="n">echo</span> &quot;<span class="n">stop</span> $<span class="n">NAME</span>&quot;<span class="p">;</span>
  <span class="n">kill</span> <span class="o">-</span><span class="n">TERM</span> `<span class="nb">cat</span> $<span class="p">{</span><span class="n">PID</span><span class="p">}</span>`
  <span class="n">rm</span> <span class="o">-</span><span class="n">f</span> $<span class="n">PID</span>
<span class="p">}</span>

<span class="n">reload</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">[</span> ! <span class="o">-</span><span class="n">e</span> $<span class="n">PID</span> <span class="p">];</span> <span class="n">then</span>
    <span class="n">echo</span> &quot;$<span class="n">NAME</span> <span class="n">not</span> <span class="n">started</span>&quot;<span class="p">;</span>
    <span class="n">start</span>
    <span class="n">exit</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">fi</span>
  <span class="n">echo</span> &quot;<span class="n">reload</span> $<span class="n">NAME</span>&quot;<span class="p">;</span>
  <span class="n">kill</span> <span class="o">-</span><span class="n">HUP</span> `<span class="nb">cat</span> $<span class="p">{</span><span class="n">PID</span><span class="p">}</span>`
<span class="p">}</span>

<span class="n">restart</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">stop</span>
    <span class="n">start</span>
<span class="p">}</span>

<span class="k">case</span> &quot;$<span class="mi">1</span>&quot; <span class="n">in</span>
  <span class="n">start</span><span class="p">)</span>
    <span class="n">start</span>
    <span class="p">;;</span>
  <span class="n">stop</span><span class="p">)</span>
    <span class="n">stop</span>
    <span class="p">;;</span>
  <span class="n">force</span><span class="o">-</span><span class="n">stop</span><span class="p">)</span>
    <span class="n">force_stop</span>
    <span class="p">;;</span>
  <span class="n">reload</span><span class="p">)</span>
    <span class="n">reload</span>
    <span class="p">;;</span>
  <span class="n">restart</span><span class="p">)</span>
    <span class="n">restart</span>
    <span class="p">;;</span>
  <span class="o">*</span><span class="p">)</span>
    <span class="n">echo</span> &quot;<span class="n">Syntax</span> <span class="n">Error</span><span class="p">:</span> <span class="n">release</span> <span class="p">[</span><span class="n">start</span><span class="o">|</span><span class="n">stop</span><span class="o">|</span><span class="n">force</span><span class="o">-</span><span class="n">stop</span><span class="o">|</span><span class="n">reload</span><span class="o">|</span><span class="n">restart</span><span class="p">]</span>&quot;
    <span class="p">;;</span>
<span class="n">esac</span>
</pre></div>


<p>permissionを設定し、スタートしておく。</p>
<div class="highlight"><pre><span class="c">% sudo chmod 755 /etc/init.d/redmine</span>
<span class="c">% sudo /etc/init.d/redmine start</span>
</pre></div>


<p>自動起動設定もしておく。</p>
<div class="highlight"><pre><span class="c">% sudo update-rc.d redmine defaults</span>
</pre></div>


<p>nginxをインストールし、redmineサイト用の設定ファイルを追加する。</p>
<div class="highlight"><pre><span class="c">% sudo apt-get install nginx</span>
<span class="c">% sudo vi /etc/nginx/sites-available/redmine</span>
<span class="n">upstream</span> <span class="n">redmine</span> <span class="p">{</span>
  <span class="n">server</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8079</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">server</span> <span class="p">{</span>
  <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
  <span class="n">server_name</span> <span class="n">redmine</span><span class="p">.</span><span class="n">hogehoge</span><span class="p">.</span><span class="n">com</span><span class="p">;</span> ← ★ここは自分のものにあわせて変更する
  <span class="n">server_tokens</span> <span class="n">off</span><span class="p">;</span>
  <span class="n">root</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">redmine</span><span class="o">/</span><span class="n">redmine</span><span class="p">;</span>

  <span class="n">client_max_body_size</span> <span class="mi">20</span><span class="n">m</span><span class="p">;</span>

  # <span class="n">individual</span> <span class="n">nginx</span> <span class="n">logs</span> <span class="k">for</span> <span class="n">this</span> <span class="n">gitlab</span> <span class="n">vhost</span>
  <span class="n">access_log</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">redmine_access</span><span class="p">.</span><span class="nb">log</span><span class="p">;</span>
  <span class="n">error_log</span>   <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">redmine_error</span><span class="p">.</span><span class="nb">log</span><span class="p">;</span>

  <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
    <span class="n">try_files</span> $<span class="n">uri</span> $<span class="n">uri</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span> $<span class="n">uri</span><span class="p">.</span><span class="n">html</span> <span class="p">@</span><span class="n">redmine</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">location</span> <span class="p">@</span><span class="n">redmine</span> <span class="p">{</span>
    <span class="n">proxy_redirect</span>     <span class="n">off</span><span class="p">;</span>
    <span class="n">proxy_set_header</span>   <span class="n">X</span><span class="o">-</span><span class="n">FORWARDED_PROTO</span> $<span class="n">http_x_forwarded_proto</span><span class="p">;</span>
    <span class="n">proxy_set_header</span>   <span class="n">Host</span>              $<span class="n">http_host</span><span class="p">;</span>
    <span class="n">proxy_set_header</span>   <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span>         $<span class="n">http_x_forwarded_for</span><span class="p">;</span>
    <span class="n">proxy_set_header</span>   <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span>   $<span class="n">http_x_forwarded_for</span><span class="p">;</span>
    <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">redmine</span><span class="p">;</span>
    <span class="n">proxy_intercept_errors</span> <span class="n">on</span><span class="p">;</span>
    <span class="n">error_page</span> <span class="mi">404</span> <span class="o">/</span><span class="mf">404.</span><span class="n">html</span><span class="p">;</span>
    <span class="n">error_page</span> <span class="mi">422</span> <span class="o">/</span><span class="mf">422.</span><span class="n">html</span><span class="p">;</span>
    <span class="n">error_page</span> <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="o">/</span><span class="mf">500.</span><span class="n">html</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>サイトを有効化してnginxを起動する。</p>
<div class="highlight"><pre><span class="c">% cd /etc/nginx/sites-enabled</span>
<span class="c">% sudo ln -s ../sites-available/redmine</span>
<span class="c">% sudo /etc/init.d/nginx restart</span>
</pre></div>


<p>この状態で<code>http://debianサーバ/</code>でredmineにアクセスできるはず。</p>
<h1>Backlogsプラグイン</h1>
<h2>Redminの設定</h2>
<p>Backlogsの導入時にはBacklogs用のトラッカーを設定する必要があるので、Redmineの設定をしておく。</p>
<p>まずはRedmineにログインする。管理者の初期設定は、ユーザ・パスワードともに<code>admin</code>となっている。
<strong>「管理＞ユーザー」からユーザ<code>admin</code>のパスワードを必ず変更する。</strong></p>
<h4>ロールと権限</h4>
<p>必要なものを登録しておく。</p>
<p>複雑にすると使いにくくなるので、個人的には以下の設定で十分だと思う。</p>
<ul>
<li>管理者 → 「メンバー」に名前変更</li>
<li>開発者 → 削除</li>
<li>報告書 → 削除</li>
</ul>
<h4>トラッカー</h4>
<p>「管理＞トラッカー」から以下のトラッカーを追加する。最初からあるものは消してしまっても構わない。バグは最初からあるものを使って構わない。</p>
<ul>
<li>タスク</li>
<li>ストーリー</li>
<li>バグ</li>
<li>課題</li>
</ul>
<h4>チケットのステータス</h4>
<p>「管理＞チケットのステータス」から以下のステータスを作成する。最初からあるものは消す。</p>
<ul>
<li>Todo（デフォルト値）</li>
<li>Doing</li>
<li>Done（終了したチケット）</li>
</ul>
<h4>ワークフロー</h4>
<p>全部のトラッカーに関してステータスを相互に変更できるように設定する。使い方にもよるが、基本的には非メンバや匿名ユーザは変更できないようにしてしまって問題ない。</p>
<h2>Backlogsの組込み</h2>
<p>最新版を取得してくる。</p>
<div class="highlight"><pre><span class="c">% alias sr=&quot;sudo -u redmine&quot;</span>
<span class="c">% cd /home/redmine/redmine/plugins</span>
<span class="c">% sr git clone git://github.com/backlogs/redmine_backlogs.git</span>
</pre></div>


<p>redmineに導入する。</p>
<div class="highlight"><pre><span class="c">% cd redmine_backlogs</span>
<span class="c">% sr RAILS_ENV=production bundle install --without development test</span>
<span class="c">% cd ../..</span>
<span class="c">% sr RAILS_ENV=production bundle install --without development test</span>
<span class="c">% sr RAILS_ENV=production bundle exec rake db:migrate</span>
<span class="c">% sr RAILS_ENV=production bundle exec rake tmp:cache:clear</span>
<span class="c">% sr RAILS_ENV=production bundle exec rake tmp:sessions:clear</span>
<span class="c">% sr RAILS_ENV=production bundle exec rake redmine:backlogs:install</span>
<span class="n">Which</span> <span class="n">trackers</span> <span class="n">do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">your</span> <span class="n">stories</span>?
  <span class="mf">1.</span> タスク
  <span class="mf">2.</span> ストーリー
  <span class="mf">3.</span> バグ
  <span class="mf">4.</span> 課題
<span class="n">Separate</span> <span class="n">values</span> <span class="n">with</span> <span class="n">a</span> <span class="n">space</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="mi">1</span> <span class="mi">3</span><span class="p">):</span> <span class="mi">2</span> ← ★先ほど作った「ストーリー」を選択
<span class="n">Which</span> <span class="n">tracker</span> <span class="n">do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">your</span> <span class="n">tasks</span>?
  <span class="mf">1.</span> タスク
  <span class="mf">2.</span> バグ
  <span class="mf">3.</span> 課題
<span class="n">Choose</span> <span class="n">one</span> <span class="n">from</span> <span class="n">above</span> <span class="p">(</span><span class="n">or</span> <span class="n">choose</span> <span class="n">none</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">tracker</span><span class="p">):</span> <span class="mi">1</span> ← ★先ほど作った「タスク」を選択
</pre></div>


<p>これでBacklogsが使えるようになっているはず。</p>
<p>最終的に「管理＞情報」では以下のように表示された。</p>
<div class="highlight"><pre><span class="n">Environment</span><span class="o">:</span>
  <span class="n">Redmine</span> <span class="n">version</span>                <span class="mf">2.6</span><span class="o">.</span><span class="mi">5</span><span class="o">.</span><span class="na">stable</span>
  <span class="n">Ruby</span> <span class="n">version</span>                   <span class="mf">2.1</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">p273</span> <span class="o">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">13</span><span class="o">)</span> <span class="o">[</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">]</span>
  <span class="n">Rails</span> <span class="n">version</span>                  <span class="mf">3.2</span><span class="o">.</span><span class="mi">21</span>
  <span class="n">Environment</span>                    <span class="n">production</span>
  <span class="n">Database</span> <span class="n">adapter</span>               <span class="n">PostgreSQL</span>
<span class="n">SCM</span><span class="o">:</span>
  <span class="n">Subversion</span>                     <span class="mf">1.8</span><span class="o">.</span><span class="mi">10</span>
  <span class="n">Git</span>                            <span class="mf">2.1</span><span class="o">.</span><span class="mi">4</span>
  <span class="n">Filesystem</span>                     
<span class="n">Redmine</span> <span class="n">plugins</span><span class="o">:</span>
  <span class="n">redmine_backlogs</span>               <span class="n">v1</span><span class="o">.</span><span class="mf">0.6</span>
</pre></div>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'pman0214-plog'; // required: replace example with your forum shortname

                    var disqus_identifier = 'redmine-install';
                var disqus_url = 'http://pman0214.github.io/blog/redmine-install.html';

            var disqus_config = function () {
                this.language = "ja";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
    <p>
        <strong>About pman0214</strong><br/>
        ハードからソフトまで分かる研究者。そういうものに私はなりたい。
    </p>
</div>
<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://www.facebook.com/pman0214"><i class="fa fa-facebook-square fa-lg"></i> facebook</a></li>
                <li class="list-group-item"><a href="https://twitter.com/pman0214"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
                <li class="list-group-item"><a href="https://github.com/pman0214"><i class="fa fa-github-square fa-lg"></i> github</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="http://pman0214.github.io/blog/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                    <li class="list-group-item tag-1">
                        <a href="http://pman0214.github.io/blog/tag/debian.html">
                            debian
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://pman0214.github.io/blog/tag/python.html">
                            python
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/info.html">
                            info
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/blog.html">
                            blog
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/github.html">
                            github
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/efi.html">
                            efi
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/pelican.html">
                            pelican
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/redmine.html">
                            redmine
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/virtualenv.html">
                            virtualenv
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/backlogs.html">
                            backlogs
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://pman0214.github.io/blog/tag/cron.html">
                            cron
                        </a>
                    </li>
                </ul>
            </li>


    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.f.ait.kyushu-u.ac.jp/~ishida/" target="_blank">
                Research
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 pman0214
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://pman0214.github.io/blog/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://pman0214.github.io/blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://pman0214.github.io/blog/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'pman0214-plog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>